// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================
// ENUMS
// =====================

enum UserRole {
  ADMIN
  MENTOR
  MENTEE
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AdjustmentTargetType {
  SUBMISSION
  PAIRING
  FAMILY
}

// =====================
// USER MODEL
// =====================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      UserRole @default(MENTEE)
  avatarUrl String?

  // Family membership
  familyId String?
  family   Family? @relation(fields: [familyId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  mentorPairings    Pairing[]          @relation("MentorPairings")
  menteePairings    PairingMentee[]
  submissions       Submission[]       @relation("Submitter")
  reviewedSubmissions Submission[]     @relation("Reviewer")
  announcements     Announcement[]
  auditLogs         AuditLog[]
  pointsAdjustments PointsAdjustment[]

  @@index([familyId])
  @@index([role])
}

// =====================
// FAMILY MODEL
// =====================

model Family {
  id         String   @id @default(cuid())
  name       String   @unique
  isArchived Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members  User[]
  pairings Pairing[]

  @@index([isArchived])
}

// =====================
// PAIRING MODEL
// =====================

model Pairing {
  id       String @id @default(cuid())
  
  // Family relation
  familyId String
  family   Family @relation(fields: [familyId], references: [id])

  // Mentor relation
  mentorId String
  mentor   User   @relation("MentorPairings", fields: [mentorId], references: [id])

  // Computed points (cached for performance)
  weeklyPoints Int @default(0)
  totalPoints  Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  mentees     PairingMentee[]
  submissions Submission[]

  @@index([familyId])
  @@index([mentorId])
}

// Junction table for Pairing <-> Mentee (up to 2 mentees per pairing)
model PairingMentee {
  id        String  @id @default(cuid())
  pairingId String
  pairing   Pairing @relation(fields: [pairingId], references: [id], onDelete: Cascade)
  menteeId  String
  mentee    User    @relation(fields: [menteeId], references: [id])

  createdAt DateTime @default(now())

  @@unique([pairingId, menteeId])
  @@index([pairingId])
  @@index([menteeId])
}

// =====================
// SUBMISSION MODEL
// =====================

model Submission {
  id String @id @default(cuid())

  // Pairing relation
  pairingId String
  pairing   Pairing @relation(fields: [pairingId], references: [id])

  // Submitter
  submitterId String
  submitter   User   @relation("Submitter", fields: [submitterId], references: [id])

  // Week identification
  weekNumber Int
  year       Int

  // Image storage
  imageUrl     String
  imagePath    String // Storage path for deletion
  thumbnailUrl String?

  // Review status
  status       SubmissionStatus @default(PENDING)
  reviewerId   String?
  reviewer     User?            @relation("Reviewer", fields: [reviewerId], references: [id])
  reviewReason String?
  reviewedAt   DateTime?

  // Points
  basePoints  Int @default(0)
  bonusPoints Int @default(0)
  totalPoints Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bonusActivities SubmissionBonus[]

  // Multiple submissions per pairing per week are allowed
  @@index([pairingId])
  @@index([submitterId])
  @@index([status])
  @@index([weekNumber, year])
}

// =====================
// BONUS ACTIVITY MODEL
// =====================

model BonusActivity {
  id          String  @id @default(cuid())
  name        String
  description String?
  points      Int

  // Week/Date range
  weekNumber Int?
  year       Int?
  startDate  DateTime?
  endDate    DateTime?

  // Visibility
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  submissions SubmissionBonus[]

  @@index([isActive])
  @@index([weekNumber, year])
}

// Junction table for Submission <-> BonusActivity
model SubmissionBonus {
  id             String        @id @default(cuid())
  submissionId   String
  submission     Submission    @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  bonusActivityId String
  bonusActivity  BonusActivity @relation(fields: [bonusActivityId], references: [id])

  // Points awarded for this bonus
  pointsAwarded Int

  createdAt DateTime @default(now())

  @@unique([submissionId, bonusActivityId])
  @@index([submissionId])
  @@index([bonusActivityId])
}

// =====================
// ANNOUNCEMENT MODEL
// =====================

model Announcement {
  id      String @id @default(cuid())
  title   String
  content String @db.Text

  // Publication status
  isPublished  Boolean   @default(false)
  isPinned     Boolean   @default(false)
  publishedAt  DateTime?
  scheduledFor DateTime?

  // Author
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isPublished])
  @@index([isPinned])
  @@index([authorId])
}

// =====================
// AUDIT LOG MODEL
// =====================

model AuditLog {
  id String @id @default(cuid())

  // Action details
  action     String // e.g., "CREATE", "UPDATE", "DELETE", "APPROVE", "REJECT"
  entityType String // e.g., "Family", "Pairing", "Submission", "BonusActivity"
  entityId   String

  // Change tracking
  beforeValue Json?
  afterValue  Json?
  reason      String?

  // Actor
  actorId String
  actor   User   @relation(fields: [actorId], references: [id])

  // Timestamp (append-only, no updatedAt)
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([actorId])
  @@index([createdAt])
}

// =====================
// POINTS ADJUSTMENT MODEL
// =====================

model PointsAdjustment {
  id String @id @default(cuid())

  // Target
  targetType AdjustmentTargetType
  targetId   String

  // Adjustment
  amount Int
  reason String

  // Admin who made the adjustment
  adminId String
  admin   User   @relation(fields: [adminId], references: [id])

  // Timestamp
  createdAt DateTime @default(now())

  @@index([targetType])
  @@index([targetId])
  @@index([adminId])
  @@index([createdAt])
}
